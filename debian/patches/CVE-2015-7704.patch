Description: fix denial of service by spoofed KoD
Author: Miroslav Lichvar <mlichvar@redhat.com>
Origin: other, http://lists.ntp.org/pipermail/pool/2015-October/007631.html
Bug: http://bugs.ntp.org/show_bug.cgi?id=2901
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2015-7704

Index: ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.6.p3+dfsg.orig/ntpd/ntp_proto.c	2015-10-23 11:54:50.151482803 -0400
+++ ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c	2015-10-23 11:54:50.151482803 -0400
@@ -1148,7 +1148,7 @@
 	peer->ppoll = max(peer->minpoll, pkt->ppoll);
 	if (hismode == MODE_SERVER && hisleap == LEAP_NOTINSYNC &&
 	    hisstratum == STRATUM_UNSPEC && memcmp(&pkt->refid,
-	    "RATE", 4) == 0) {
+	    "RATE", 4) == 0 && !(peer->flash & PKT_TEST_MASK)) {
 		peer->selbroken++;
 		report_event(PEVNT_RATE, peer, NULL);
 		if (pkt->ppoll > peer->minpoll)
