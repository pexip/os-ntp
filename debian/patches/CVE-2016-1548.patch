Description: fix time spoofing via interleaved symmetric mode
Origin: vendor, http://pkgs.fedoraproject.org/cgit/rpms/ntp.git/tree/ntp-4.2.6p5-cve-2016-1548.patch
Bug: http://support.ntp.org/bin/view/Main/NtpBug2978

Index: ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.6.p3+dfsg.orig/ntpd/ntp_proto.c	2016-06-01 12:27:44.535498863 -0400
+++ ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c	2016-06-01 12:27:44.535498863 -0400
@@ -305,6 +305,7 @@
 	int	authlen;		/* offset of MAC field */
 	int	is_authentic = 0;	/* cryptosum ok */
 	int	retcode = AM_NOMATCH;	/* match code */
+	int	xleave_mismatch = 0;	/* mismatch in xleave mode */
 	keyid_t	skeyid = 0;		/* key IDs */
 	u_int32	opcode = 0;		/* extension field opcode */
 	sockaddr_u *dstadr_sin; 	/* active runway */
@@ -1133,9 +1134,8 @@
 		}
 
 	/*
-	 * Check for bogus packet in basic mode. If found, switch to
-	 * interleaved mode and resynchronize, but only after confirming
-	 * the packet is not bogus in symmetric interleaved mode.
+	 * Check for bogus packet in basic mode. If found, check if it's not
+	 * a valid packet in symmetric interleaved mode.
 	 */
 	} else if (peer->flip == 0) {
 		if (L_ISZERO(&p_org) || !L_ISEQU(&p_org, &peer->aorg)) {
@@ -1143,8 +1143,7 @@
 			peer->flash |= TEST2;	/* bogus */
 			if (!L_ISZERO(&peer->dst) && L_ISEQU(&p_org,
 			    &peer->dst)) {
-				peer->flip = 1;
-				report_event(PEVNT_XLEAVE, peer, NULL);
+				xleave_mismatch = 1;
 			}
 		} else {
 			L_CLR(&peer->aorg);
@@ -1218,6 +1217,16 @@
 	}
 
 	/*
+	 * If the packet is bogus in basic mode but not in symmetric
+	 * interleaved mode and it passed the authentication check,
+	 * enable the mode and resynchronize.
+	 */
+	if (xleave_mismatch && hismode == MODE_ACTIVE) {
+		peer->flip = 1;
+		report_event(PEVNT_XLEAVE, peer, NULL);
+	}
+
+	/*
 	 * Update the state variables.
 	 */
 	if (peer->flip == 0) {
@@ -1754,6 +1763,13 @@
 	sys_rootdisp = dtemp + peer->rootdisp;
 	sys_rootdelay = peer->delay + peer->rootdelay;
 	sys_reftime = peer->dst;
+	
+	/* Randomize the fraction part of the reference time to not reveal
+	   peer->dst to NTP clients as it could be used in a DoS attack
+	   enabling the symmetric interleaved mode with spoofed packets */
+	ntp_crypto_random_buf(&sys_reftime.l_uf, sizeof (sys_reftime.l_uf));
+	if (L_ISHIS(&sys_reftime, &peer->dst))
+		sys_reftime.l_ui--;
 
 #ifdef DEBUG
 	if (debug)
