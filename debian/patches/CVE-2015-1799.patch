Description: protect symmetric associations against DoS attacks
Bug: http://bugs.ntp.org/show_bug.cgi?id=2781

--- ntp-4.2.6p3+dfsg.orig/ntpd/ntp_proto.c	2015-03-04 11:59:04.557881767 +0100
+++ ntp-4.2.6p3+dfsg/ntpd/ntp_proto.c	2015-03-05 16:48:08.214835757 +0100
@@ -1078,16 +1078,6 @@ receive(
 	}
 
 	/*
-	 * Update the state variables.
-	 */
-	if (peer->flip == 0) {
-		if (hismode != MODE_BROADCAST)
-			peer->rec = p_xmt;
-		peer->dst = rbufp->recv_time;
-	}
-	peer->xmt = p_xmt;
-
-	/*
 	 * If this is a crypto_NAK, the server cannot authenticate a
 	 * client packet. The server might have just changed keys. Clear
 	 * the association and restart the protocol.
@@ -1129,6 +1119,16 @@ receive(
 	}
 
 	/*
+	 * Update the state variables.
+	 */
+	if (peer->flip == 0) {
+		if (hismode != MODE_BROADCAST)
+			peer->rec = p_xmt;
+		peer->dst = rbufp->recv_time;
+	}
+	peer->xmt = p_xmt;
+
+	/*
 	 * Set the peer ppoll to the maximum of the packet ppoll and the
 	 * peer minpoll. If a kiss-o'-death, set the peer minpoll to
 	 * this maximumn and advance the headway to give the sender some
