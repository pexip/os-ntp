From aa44b5835d69d8ee031736bb8ee2730a514edb7d Mon Sep 17 00:00:00 2001
From:  <jnperlin@hydra.localnet>
Date: Sun, 11 Oct 2015 08:10:20 +0200
Subject: [PATCH] [Bug 2941] NAK to the Future: Symmetric association
 authentication bypass via crypto-NAK

---
 ChangeLog        |  3 +++
 ntpd/ntp_proto.c | 18 ++++++++++++++++++
 2 files changed, 21 insertions(+)

Index: ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.6.p3+dfsg.orig/ntpd/ntp_proto.c	2015-10-23 11:56:42.020703683 -0400
+++ ntp-4.2.6.p3+dfsg/ntpd/ntp_proto.c	2015-10-23 11:56:42.016703639 -0400
@@ -939,6 +939,24 @@
 				sys_restricted++;
 				return;
 			}
+			/* [Bug 2941]
+			 * If we got here, the packet isn't part of an
+			 * existing association, it isn't correctly
+			 * authenticated, and it didn't meet either of
+			 * the previous two special cases so we should
+			 * just drop it on the floor.  For example,
+			 * crypto-NAKs (is_authentic == AUTH_CRYPTO)
+			 * will make it this far.  This is just
+			 * debug-printed and not logged to avoid log
+			 * flooding.
+			 */
+			DPRINTF(1, ("receive: at %ld refusing to mobilize passive association"
+				    " with unknown peer %s mode %d keyid %08x len %d auth %d\n",
+				    current_time, stoa(&rbufp->recv_srcadr),
+				    hismode, skeyid, (authlen + has_mac),
+				    is_authentic));
+			sys_declined++;
+			return;
 		}
 
 		/*
