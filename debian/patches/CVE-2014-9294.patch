Description: fix non-cryptographic random number generator with weak
 seed used by ntp-keygen to generate symmetric keys
Author: thanks to Red Hat for backport
Origin: vendor, https://git.centos.org/blob/rpms!ntp.git/c054b85192ea340529fc9a659cac7ea6b893b50e/SOURCES!ntp-4.2.6p5-cve-2014-9294.patch
Origin: backport, http://bk1.ntp.org/ntp-dev/?PAGE=patch&REV=548db6ddlELn4rnqUZ4kKGOjvtXwbQ
Bug: http://bugs.ntp.org/show_bug.cgi?id=2666

Index: ntp-4.2.6.p5+dfsg/include/ntp_random.h
===================================================================
--- ntp-4.2.6.p5+dfsg.orig/include/ntp_random.h	2009-12-09 02:36:35.000000000 -0500
+++ ntp-4.2.6.p5+dfsg/include/ntp_random.h	2014-12-20 05:46:18.807038967 -0500
@@ -1,6 +1,9 @@
 
 #include <ntp_types.h>
 
+void ntp_crypto_srandom(void);
+int ntp_crypto_random_buf(void *buf, size_t nbytes);
+
 long ntp_random (void);
 void ntp_srandom (unsigned long);
 void ntp_srandomdev (void);
Index: ntp-4.2.6.p5+dfsg/libntp/ntp_random.c
===================================================================
--- ntp-4.2.6.p5+dfsg.orig/libntp/ntp_random.c	2009-12-09 02:36:36.000000000 -0500
+++ ntp-4.2.6.p5+dfsg/libntp/ntp_random.c	2014-12-20 05:46:18.807038967 -0500
@@ -481,3 +481,63 @@
 	}
 	return(i);
 }
+
+/*
+ * Crypto-quality random number functions
+ *
+ * Author: Harlan Stenn, 2014
+ *
+ * This file is Copyright (c) 2014 by Network Time Foundation.
+ * BSD terms apply: see the file COPYRIGHT in the distribution root for details.
+ */
+
+#include <openssl/err.h>
+#include <openssl/rand.h>
+
+int crypto_rand_init = 0;
+
+/*
+ * ntp_crypto_srandom:
+ *
+ * Initialize the random number generator, if needed by the underlying
+ * crypto random number generation mechanism.
+ */
+
+void
+ntp_crypto_srandom(
+	void
+	)
+{
+	if (!crypto_rand_init) {
+		RAND_poll();
+		crypto_rand_init = 1;
+	}
+}
+
+/*
+ * ntp_crypto_random_buf:
+ *
+ * Returns 0 on success, -1 on error.
+ */
+int
+ntp_crypto_random_buf(
+	void *buf,
+	size_t nbytes
+	)
+{
+	int rc;
+
+	rc = RAND_bytes(buf, nbytes);
+	if (1 != rc) {
+		unsigned long err;
+		char *err_str;
+
+		err = ERR_get_error();
+		err_str = ERR_error_string(err, NULL);
+		/* XXX: Log the error */
+
+		return -1;
+	}
+	return 0;
+}
+
Index: ntp-4.2.6.p5+dfsg/util/ntp-keygen.c
===================================================================
--- ntp-4.2.6.p5+dfsg.orig/util/ntp-keygen.c	2011-12-24 18:27:16.000000000 -0500
+++ ntp-4.2.6.p5+dfsg/util/ntp-keygen.c	2014-12-20 05:46:18.811039002 -0500
@@ -261,6 +261,8 @@
 	ssl_check_version();
 #endif /* OPENSSL */
 
+	ntp_crypto_srandom();
+
 	/*
 	 * Process options, initialize host name and timestamp.
 	 */
@@ -727,7 +729,14 @@
 			int temp;
 
 			while (1) {
-				temp = ntp_random() & 0xff;
+				int rc;
+
+				rc = ntp_crypto_random_buf(&temp, 1);
+				if (-1 == rc) {
+					fprintf(stderr, "ntp_crypto_random_buf() failed.\n");
+					exit (-1);
+				}
+				temp &= 0xff;
 				if (temp == '#')
 					continue;
 
