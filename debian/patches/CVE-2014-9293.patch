Description: fix weak default key in config_auth()
Author: thanks to Red Hat
Origin: vendor, https://git.centos.org/blob/rpms!ntp.git/c054b85192ea340529fc9a659cac7ea6b893b50e/SOURCES!ntp-4.2.6p5-cve-2014-9293.patch
Bug: http://bugs.ntp.org/show_bug.cgi?id=2665

Index: ntp-4.2.6.p3+dfsg/ntpd/ntp_config.c
===================================================================
--- ntp-4.2.6.p3+dfsg.orig/ntpd/ntp_config.c	2014-12-20 06:07:14.037996587 -0500
+++ ntp-4.2.6.p3+dfsg/ntpd/ntp_config.c	2014-12-20 06:07:14.033996553 -0500
@@ -1858,13 +1858,16 @@
 		req_hashlen = digest_len;
 #endif
 	} else {
-		int	rankey;
+		unsigned char rankey[16];
+
+		if (ntp_crypto_random_buf(rankey, sizeof (rankey))) {
+			msyslog(LOG_ERR, "ntp_crypto_random_buf() failed.");
+			exit(1);
+		}
 
-		rankey = ntp_random();
 		req_keytype = NID_md5;
 		req_hashlen = 16;
-		MD5auth_setkey(req_keyid, req_keytype,
-		    (u_char *)&rankey, sizeof(rankey));
+		MD5auth_setkey(req_keyid, req_keytype, rankey, sizeof(rankey));
 		authtrust(req_keyid, 1);
 	}
 
Index: ntp-4.2.6.p3+dfsg/ntpd/ntpd.c
===================================================================
--- ntp-4.2.6.p3+dfsg.orig/ntpd/ntpd.c	2014-12-20 06:07:14.037996587 -0500
+++ ntp-4.2.6.p3+dfsg/ntpd/ntpd.c	2014-12-20 06:07:14.033996553 -0500
@@ -597,6 +597,7 @@
 	get_systime(&now);
 
 	ntp_srandom((int)(now.l_i * now.l_uf));
+	ntp_crypto_srandom();
 
 #if !defined(VMS)
 # ifndef NODETACH
